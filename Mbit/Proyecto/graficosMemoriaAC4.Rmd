---
title: "Graficos Análisis Correspondencias"
author: "Francisco Javier Gutiérrez Expósito"
output: html_document
---

```{r, echo=FALSE}
cat(paste("date:", date()))
```


```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
#Directorio de trabajo lo asignamos al raiz. 
setwd("/Users/zzddfge/Desktop/Compartida/Proyecto_Master")

origenData <- file.path(getwd(), "data")
origenMat <- file.path(getwd(), "data", "mat")
destinoCSV <- file.path(getwd(), "data", "csv")
ficheroDestino <- file.path(destinoCSV, "pacientesDiabetes.csv")
ficheroTomanA10Destino <- file.path(destinoCSV, "tomanA10.mat")
ficheroNoTomanA10Destino <- file.path(destinoCSV, "noTomanA10.mat")
ficheroFiltro <- file.path(destinoCSV, "ID_CS(NA).csv")
origenSanos <- file.path(origenMat, "MatrATC5el_norepe_Health11y12_v2016.mat")
ficheroSanos <- file.path(destinoCSV, "pacientesSanos.csv")

source("analisisbasico.R")
source("ac4.R")

#procesamos el CSV final.
ficheros <- c(ficheroDestino, ficheroFiltro, ficheroSanos)
csv <- procesaCSVDiabeticos(ficheros)
#csv <- procesaCSVSanos(ficheros)

rm(origenData)
rm(origenMat)
rm(destinoCSV)
rm(ficheroDestino)
rm(ficheroTomanA10Destino)
rm(ficheroFiltro)
rm(ficheros)

suppressWarnings(par(new=TRUE))
par(mfrow=c(1,1), mar=c(4,4,3,2))
```

#Revisión de Análisis de Correspondencia 

ORIGEN DE INFORMACIÓN: Estamos escogiendo todos los datos existentes, ya que se trata de ver los patrones que hay en cada año (de momento, 2011 y 2012). Por tanto, no nos estamos limitando a los pacientes que están en ambos años o, a solo a los pacientes que estaban en un grupo en 2011 para ver cómo ha evolucionado. 

COMPARATIVAS: Vamos a generar el análisis de correspondencia simple de dos variables. Las combinaciones que se van a generar son:

  a) ATCs (16 ATCs) y CRGs (5424, 6144, 7071)
    a.1) Se realizará usando el TOTAL de dispensaciones.
    
    a.2) Se realizará convirtiendo a OCURRENCIA (1 cuando exita alguna dispensación).
  
  b) ATCs (16 ATCs) y Sexo
    b.1) Se realizará usando el TOTAL de dispensaciones.
    
    b.2) Se realizará convirtiendo a OCURRENCIA (1 cuando exita alguna dispensación).
  
  c) ATCs (16 ATCs) y Edad (rango de edad en 7 grupos por percentiles)
    c.1) Se realizará usando el TOTAL de dispensaciones.
    
    c.2) Se realizará convirtiendo a OCURRENCIA (1 cuando exita alguna dispensación).

Los 16 ATCs que se van a utilizar son los que se han encontrado con mayor probabilidad en cada CRG-base. Son:
```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
  cat("\n\n\t\tATCS: ")
  cat(atcImportantes)
  cat("\n\n")
  par(mfrow=c(1,4), mar=c(3,3,2,2))
  d <- csv[, c(atcImportantes, "Anyo")]
  cat("\n\n<b>Distribución de los ATCs importantes</b>\n\n")
  for (i in 1:length(atcImportantes)) {
    boxplot(d[,i] ~ d$Anyo, main=colnames(d)[i], ylab="Disposiciones")
  }
  cat("\n\n\t\tSe puede observar que en general parece que la distribución en 2012 tiene una cola un poco 
      menor, aunque por lo que se puede observar parece que la mediana no cambia. Como hay muchos pacientes 
      que no están tomando estos ATCs puede que afecte a la mediana, así que merece la pena revisar la 
      distribución sin contabilizar los 0's.\n\n")

  cat("\n\n<b>Distribución de los ATCs importantes sin 0's</b>\n\n")
  for (i in 1:length(atcImportantes)) {
    a <- d[d[,i] >0, c(i,length(atcImportantes)+1)]
    boxplot(a[,1] ~ a$Anyo, main=colnames(d)[i], ylab="Disposiciones")
  }
  cat("\n\n\t\tNo se observa grandes cambios (las cajas parecen que estar un poco más arriba) en relación 
      a la mediana. La escala es muy grande por el número de outliers posiblemente se vea algo más si 
      aplicamos el logaritmo para 'bajar' la escala.\n\n")

  cat("\n\n<b>Distribución de los ATCs importantes sin 0's y reducido a Logs</b>\n\n")
  for (i in 1:length(atcImportantes)) {
    a <- d[d[,i] >0, c(i,length(atcImportantes)+1)]
    a[,1] <- log(a[,1])
    boxplot(a[,1] ~ a$Anyo, main=paste("Log", colnames(d)[i]), ylab="Disposiciones")
  }
  cat("\n\n\t\tSe puede observar que efectivamente tiene menos outliers en el 2012 que en 2011 de forma 
      general. Además, algunas cajas sí que se ven algo más chicas en 2012 que en 2011 pero, la mediana 
      no cambia entre los años. Todo apunta a que, al menos en esto ATCs, en el 2012 a pesar de tener más 
      pacientes la distribución de la suma de disposiciones.\n\n")

  par(mfrow=c(1,1))
  rm(d)
  rm(i)
  rm(a)
```


No replicamos en este HTML el apartado d) [CRGs (5424, 6144, 7071) y Sexo] y e) [CRG(5424, 6144, 7071) y Edad (rango de edad en 7 grupos por percentiles)] porque como no están involucrados los ATCs no presentarán cambios con respecto a lo ya analizado. 

Por último, se generará el análisis de correspondencia múltiple de tres variables. Las combinaciones que se van a generar son:

  f) ATCs (16 ATCs), CRGs (5424, 6144, 7071) y Rango de Edad (7 percentiles)
  
  g) ATCs (16 ATCs), CRGs (5424, 6144, 7071) y Sexo
  
  h) Al igual que ocurre con los apartados d) y e), este apartado[CRGs (5424, 6144, 7071), Rango de Edad (7 percentiles) y Sexo] no se va a volver a generar

NOTA: En estos casos (MAC), la reducción de los ATCs ha sido por "EXISTENCIA". Es decir, se tiene en cuenta para cada paciente si hay ocurrencia o no de los ATCs.

  i) Este apartado es para sacar lo que tenía pendiente:
    
    * Selección de Ids de pacientes que en 2011 estaban en CRG-base de 5424.
    
    * Valores categóricos por ATC (16 ATCs más importantes) de esos pacientes en 2011. 
    
    * Valores de CRG-base de esos pacientes para 2012. Nos quedamos con 5424, 6144 y 7071.
    

##A.1) AC Simple con TOTAL de Disposiciones: ATCs - CRG: 5424, 6144, 7071.

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "A.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGDiabHipertensionAtc(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(A.1).1.", anyo,
              " - Mosaico de ATCs - CRGs[5424, 6144, 7071]</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 3
    rows <- 1
    main <- paste("[", anyo, "] Mosaico de ATCs - CRGs[5424, 6144, 7071]", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).2.", anyo, " - Explicación Varianza - CRGs-ATCs</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).3.", anyo, " - Contribución a la Dimensión - CRGs-ATCs</b>\n\n"))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).4.", anyo, " - Gráfico Simétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - CRGs-ATCs para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(A.1).5.", anyo, " - Gráfico Asimétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##A.2) AC Simple de OCURRENCIA: ATCs - CRG: 5424, 6144, 7071.

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "A.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGDiabHipertensionAtc(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(A.2).1.", anyo,
              " - Mosaico de ATCs - CRGs[5424, 6144, 7071]</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 3
    rows <- 1
    main <- paste("[", anyo, "] Mosaico de ATCs - CRGs[5424, 6144, 7071]", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).2.", anyo, " - Explicación Varianza - CRGs-ATCs</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).3.", anyo, " - Contribución a la Dimensión - CRGs-ATCs</b>\n\n"))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).4.", anyo, " - Gráfico Simétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - CRGs-ATCs para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(A.2).5.", anyo, " - Gráfico Asimétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##B.1) AC Simple con TOTAL de Disposiciones: ATCs (16 familias) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "B.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getAtcSexo(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(B.1).1.", anyo," - Mosaico de ATCs - Sexo</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 2
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Sexo",sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).2.", anyo, " - Explicación Varianza - ATCs-Sexo</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D.1", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(B.1).2b.", anyo, " - Test de Malinvaud</b>\n\n", sep=""))
    EscribeTestMalinvaud(p, min(ncol(m)-1, nrow(m)-1))

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).3.",anyo," - Contribución a la Dimensión-ATCs-Sexo</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).4.", anyo, " - Gráfico Simétrico - ATCs-Sexo</b>\n\n", sep=""))
      
      par(mfrow=c(1,1), mar=c(4,4,2,2))
      counter <- 1
      numb.dim.cols<-ncol(m)-1
      numb.dim.rows<-nrow(m)-1
      a <- min(numb.dim.cols, numb.dim.rows)
      p$col$coord <- cbind(p$col$coord, rep(0, 2))
      xmin = range(p$row$coord[1], p$col$coord[1])[1] * 1.1
      plot(p$row$coord, rep(0,length(atcImportantes)),type = "p", pch = 16, col="blue",xlab="Dimensión 1",
           ylab="", main = paste("[",anyo,"] - ATCs[14 familias] y Sexo",sep=""), cex.main=0.7)
    points(p$col$coord, type = "p", pch = 17, col="red")
    for (i in 1:nrow(m)) {
      text(p$row$coord[i], 0.20, rownames(m)[i], col="blue", cex=0.6)
    }
    for (i in 1:ncol(m)) {
      text(p$col$coord[i], p$col$coord[i] + 0.15, colnames(m)[i], col="red", cex=0.6)
    }
    abline(h=0,lty=2)
    abline(v=0,lty=2) 
    cat("\n\n")
    
    rm(counter)
    rm(numb.dim.cols)
    rm(numb.dim.rows)
    rm(a)
    rm(xmin)
    rm(i)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat("\n\nComo se ha comentado antes, no se puede representar la <b>gráfica A-simétrica ATCs-Sexo</b>")
    cat("\n\n")
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##B.2) AC Simple de OCURRENCIA: ATCs (16 familias principales) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "B.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    m <- getAtcSexo(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(B.2).1.", anyo, " - Mosaico de ATCs - Sexo", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 2
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Sexo",sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).2.", anyo, " - Explicación Varianza - ATCs-Sexo</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D.1", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(B.2).2b.", anyo, " - Test de Malinvaud</b>\n\n", sep=""))
    EscribeTestMalinvaud(p, min(ncol(m)-1, nrow(m)-1))

    cat("####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).3.", anyo, 
              " - Contribución a la Dimensión - ATCs-Sexo</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).4.", anyo, " - Gráfico Simétrico - ATCs-Sexo</b>\n\n", sep=""))
      par(mfrow=c(1,1), mar=c(4,4,2,2))
      counter <- 1
      numb.dim.cols<-ncol(m)-1
      numb.dim.rows<-nrow(m)-1
      a <- min(numb.dim.cols, numb.dim.rows)
      p$col$coord <- cbind(p$col$coord, rep(0, 2))
      xmin = range(p$row$coord[1], p$col$coord[1])[1] * 1.1
      plot(p$row$coord, rep(0,length(atcImportantes)), type = "p", pch = 16, col="blue",
       xlab="Dimensión 1", ylab="",
       main = paste("[", anyo, "] - ATCs[16 atcs] y Sexo", sep=""), cex.main=0.7
      )
    points(p$col$coord, type = "p", pch = 17, col="red")
    for (i in 1:nrow(m)) {
      text(p$row$coord[i], 0.20, rownames(m)[i], col="blue", cex=0.6)
    }
    for (i in 1:ncol(m)) {
      text(p$col$coord[i], p$col$coord[i] + 0.15, colnames(m)[i], col="red", cex=0.6)
    }
    abline(h=0,lty=2)
    abline(v=0,lty=2) 
    cat("\n\n")
    
    rm(counter)
    rm(numb.dim.cols)
    rm(numb.dim.rows)
    rm(a)
    rm(xmin)
    rm(i)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat("\n\nComo se ha comentado antes, no se puede representar la <b>gráfica A-simétrica ATCs-Sexo</b>")
    cat("\n\n")
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##C.1) AC Simple de TOTAL de Disposiciones: ATCs (16 familias) y Edad (rango de edad en 7 grupos por percentiles)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "C.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    csv <- getRangoEdad(csv, anyo)
    m <- getAtcEdad(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(C.1).1.", anyo, " - Mosaico de ATCs - Rango Edad", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 7
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Rango de Edad", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).2.", anyo, " - Explicación Varianza - ATCs-Rango Edad</b>", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("####\n\nDistribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).3.", anyo, " - Contribución a la Dimensión - ATCs-Rango Edad</b>"))
    EscribeContribucionDimension(m, 10)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).4.", anyo, " - Gráfico Simétrico - ATCs-Rango Edad</b>", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - ATCs-Rango de Edad para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(C.1).5.", anyo, " - Gráfico Asimétrico - ATCs-Rango Edad</b>", sep=""))
    cat("\n\n--> ColPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n--> RowPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "rowprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##C.2) AC Simple con Reducción de OCURRENCIA: ATCs (16 ATCs importantes) y Edad (rango de edad en 7 grupos por percentiles)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "C.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    csv <- getRangoEdad(csv, anyo)
    m <- getAtcEdad(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(C.2).1.", anyo, " - Mosaico de ATCs - Rango Edad", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 7
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Rango de Edad", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).2.", anyo, " - Explicación Varianza - ATCs-Rango Edad</b>", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).3.", anyo, " - Contribución a la Dimensión - ATCs-Rango Edad</b>"))
    EscribeContribucionDimension(m, 10)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).4.", anyo, " - Gráfico Simétrico - ATCs-Rango Edad</b>", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - ATCs-Rango de Edad para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(C.2).5.", anyo, " - Gráfico Asimétrico - ATCs-Rango Edad</b>", sep=""))
    cat("\n\n--> ColPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n--> RowPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "rowprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##D) AC Simple: CRGs (5424, 6144, 7070, 7071) y Sexo

No generamos nada. 

##E) AC Simple: CRG(5424, 6144, 7071) y Edad (rango de edad en 7 grupos por percentiles)

No generamos nada.

##F) MAC: ATCs (16 atcs importantes), CRGs (5424, 6144, 7071) y Rango de Edad

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "F"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCsCRGsEdad(csv, anyo)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.F.1.", anyo, " - Explicación Varianza - ATCs - CRGs - 
              Rango de Edad</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
         labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)
    
    #cat("\n\n- Resumen del MCA\n\n")
    #summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.F.2.", anyo, " - Simétrico (representa las variables) - ATCs - CRGs - 
              Rango de Edad</b>\n\n",sep=""))
    a <- fviz_mca_var(p) +
      labs(title=paste("[",anyo,"] - MCA Variables [ATCs, CRGs, Rango de Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
        
    cat(paste("\n\n<b>Gráfico MAC.F.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              ATCs - CRGs - Rango de Edad</b>\n\n",sep=""))
    #a <- fviz_mca_ind(p) +
    a <- plot(p, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Rango de Edad]"), 
              cex.main=0.7, habillage=17) 
    print(a)
    par(mfrow=c(1,3))
    for( crg in unique(df$CRG)) {
      p1 <- getATCsMCA(subset(df, df$CRG==crg))
      a <- plot(p1, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Rango de Edad]"), 
              cex.main=0.7, habillage=17, ylim=c(-3, 3), xlim=c(-1.0, 2.0)) 
      print(a)
    }
    rm(p1)
    par(mfrow=c(1,1))
        
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.a", anyo, 
              " - A-Simétrico (relación no existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0")) 
            ) +
      labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico MAC.F.4.b", anyo, 
              " - A-Simétrico (relación existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1")) 
            ) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
 
    cat(paste("\n\n<b>Gráfico MAC.F.4.c", anyo, 
              " - A-Simétrico (relación CRG-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
                                     "R1", "R2", "R3", "R4", "R5", "R6", "R7"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables [CRGs, Rango Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "H", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.d", anyo, 
              " - A-Simétrico (relación no existencia ATC-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("R1","R2", "R3", "R4", "R5", "R6", "R7",
               "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0")))+
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,Rango]"))
    print(a)
    pintaNotaAnalisis(pintar, "I", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.e", anyo, 
              " - A-Simétrico (relación existencia ATC-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("R1","R2", "R3", "R4", "R5", "R6", "R7",
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,Rango]"))
    print(a)
    pintaNotaAnalisis(pintar, "J", anyo, 0, 0)

    rm(p)
    rm(a)
    rm(df)
}
```

##G) MAC: ATCs (16 familias), CRGs (5424, 6144, 7071) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "G"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCsCRGsSexo(csv, anyo)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.G.1.", anyo, " - Explicación Varianza - ATCs - CRGs - 
              Sexo</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp = 100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    
    #cat("\n\n- Resumen del MCA\n\n")
    #summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.G.2.", anyo, " - Simétrico (representa las variables) - ATCs - CRGs - 
              Sexo</b>\n\n",sep=""))
    a <- fviz_mca_var(p) +
            labs(title=paste("[",anyo,"] - MCA Variables [ATCs, CRGs, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
        
    cat(paste("\n\n<b>Gráfico MAC.G.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              ATCs - CRGs - Sexo</b>\n\n",sep=""))
    a <- plot(p, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Sexo]"), 
              cex.main=0.7, habillage=18) 
    print(a)
    par(mfrow=c(1,2))
    for( sexo in unique(df$Sexo)) {
      p1 <- getATCsMCA(subset(df, df$Sexo==sexo))
      a <- plot(p1, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Rango de Edad]"), 
              cex.main=0.7, habillage=18, ylim=c(-1, 2), xlim=c(-2, 3)) 
      print(a)
      rm(p1)
    }
    rm(sexo)
    par(mfrow=c(1,1))

    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat(paste("\n\n<b>Gráfico MAC.G.4.a", anyo, 
              " - A-Simétrico (relación no existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0"))) +  
      labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico MAC.G.4.b", anyo, 
              " - A-Simétrico (relación existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1"))) +  
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
 
    cat(paste("\n\n<b>Gráfico MAC.G.4.c", anyo, 
              " - A-Simétrico (relación CRG-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
                                     "Sexo_1", "Sexo_2"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables [CRGs, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "H", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.G.4.d", anyo, 
              " - A-Simétrico (relación no existencia ATC-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("Sexo_1","Sexo_2", 
              "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0"))) + 
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "I", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.G.4.e", anyo, 
              " - A-Simétrico (relación existencia ATC-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("Sexo_1","Sexo_2", 
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "J", anyo, 0, 0)

    rm(p)
    rm(a)
    rm(df)
}
```

##H) MAC: CRGs (5424, 6144, 7071), Rango de Edad(7 percentiles) y Sexo

No generamos nada.

##I) MAC: CRGs de 2012 (5424, 6144, 7071), ATCs del 2011

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "I"

  cat(paste("\n\n###Año ", anyo, sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCs2011CRGs2012(csv)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.I.1.", anyo, " - Explicación Varianza - CRGs_2012 - 
              ATCs_2011</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp = 100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    
    cat("\n\n- Resumen del MCA\n\n")
    summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.I.2.", anyo, " - Simétrico (representa las variables) - CRGs_2012 - 
              ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_var(p)
    print(a)
    
    cat(paste("\n\n<b>Gráfico MAC.I.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              CRGs_2012 - ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_ind(p)
    print(a)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat(paste("\n\n<b>Gráfico MAC.I.4.", anyo, " - A-Simétrico General - CRGs_2012 - 
              ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p, label="var", axes=c(1,2), mode="colprincipal", arrows=c(TRUE, FALSE))
    print(a)
    
    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat("\n\n<b>Gráfico MAC.I.4.a - A-Simétrico (relación no Existencia CRG_2012 - 
        ATC_2011)  - Dimensión 1 y 2</b>\n\n")
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0")))
    print(a)

   cat("\n\n<b>Gráfico MAC.I.4.b - A-Simétrico (relación Existencia CRG_2012 - 
        ATC_2011) - Dimensión 1 y 2</b>\n\n")
     a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal",
              select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1")))
    print(a)
    
    cat("\n\n<b>Gráfico MAC.I.4.c - A-Simétrico (relación no Existencia CRG_2012 - 
        ATC_2011)  - Dimensión 3 y 4</b>\n\n")
    a <- fviz_mca_biplot(p,label="var",axes=c(1,3),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_0","A03FA_0","A06AD_0","A10BA_0","A10AE_0","B01AC_0","C03CA_0","C08CA_0","C09AA_0",
              "C10AA_0","G04CA_0","J01MA_0","M02AA_0","N02BB_0","N02BE_0","N05AL_0","R03AC_0","R03AK_0",
              "R03BB_0","R05CB_0", "N05BA_0")))
    print(a)

   cat("\n\n<b>Gráfico MAC.I.4.d - A-Simétrico (relación Existencia CRG_2012 - 
        ATC_2011) - Dimensión 3 y 4</b>\n\n")
     a <- fviz_mca_biplot(p,label="var",axes=c(1,3),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal",
              select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A02BC_1","A03FA_1","A06AD_1","A10BA_1","A10AE_1","B01AC_1","C03CA_1","C08CA_1","C09AA_1",
              "C10AA_1","G04CA_1","J01MA_1","M02AA_1","N02BB_1","N02BE_1","N05AL_1","R03AC_1","R03AK_1",
              "R03BB_1","R05CB_1", "N05BA_1")))
    print(a)

    rm(p)
    rm(a)
    rm(df)
```


##J) Perfil de los ATCs que están en 2011 como 5424 para ver el perfil de ATCs (normalizado según número pacientes)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
m <- matrix(nrow=0, ncol=4)
Ids <- getIds2011CRGs2012(csv)
atc_2011 <- subset(csv, csv$Anyo==2011 & csv$Id %in% Ids$Id, c(1, 7:(ncol(csv) - N)))

#Iteramos por año.
for (anyo in unique(csv$Anyo)) {
  #Generamos título Nivel 2
  cat(paste("\n\n##Año ", anyo, "\n\n"))
  
  cat("###Generacíon de gráficas individuales por CRG-base\n\n")
  
  atc <- subset(csv, csv$Anyo == anyo & csv$Id %in% Ids$Id, c(1,6,7:(ncol(csv) - N)))
  par(mfrow=c(2,1), mar=c(3,2,3,2))
  i <- 1
  for (crg in unique(atc$CRG)) {
    cat(paste("\n\nGráfica ATC.CRG[", crg, "] - ", anyo, 
                " - Distribución de la Proporción de la toma de ATCs",
                ", Número de pacientes: ", length(atc[atc$CRG==crg, "CRG"]), "\n\n", sep=""))

    #Filtramos por el ATC y quitamos la columna del CRG.
    atc_crg <- subset(atc, atc$CRG == crg, c(-2))
    atc_crg_2011 <- subset(atc_2011, atc_2011$Id %in% atc_crg$Id, c(-1))
    atc_crg <- atc_crg[,-1]
    
    #Sumamos el total de las dispensaciones.
    t <- apply(atc_crg, 2, convierteExistencia)
    atc_col <- 100*apply(t, 2, sum)/nrow(t)

    t <- apply(atc_crg_2011, 2, convierteExistencia)
    atc_col_2011 <- 100*apply(t, 2, sum)/nrow(t)

    label=c("A", "B", "C", "D", "G", "H", "J", "L", "M", "N", "P", "R", "S", "V")
    pos=c(92,128,207,273,314,335,415,452,484,563,586,629,663,748)

    #Gráfica con patrón del 2011
    plot(atc_col_2011, type = "l", cex.axis = 0.7, xaxt="n", 
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    axis(1, at=pos, labels= label, cex.axis = 0.5)
    title(main="CRG fijo: 5424 - Ocurrencia de ATC en 2011", cex.main=0.65)

    #Gráfica con patrón del año en iteración
    plot(atc_col, type = "l", cex.axis = 0.7, xaxt="n", 
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    axis(1, at=pos, labels= label, cex.axis = 0.5)
    title(main=paste("CRG:", crg, ", Año:", anyo, " - Ocurrencia de ATC (iteración)", sep=""), 
            cex.main=0.65)

    #Zoom fijo en 2011
    plot(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)], type = "l", cex.axis = 0.7, xaxt="n",
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    points(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)], pch=19)
    axis(1, at=1:length(names(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)])), 
           labels=names(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)]), cex.axis = 0.5, las=3)
    title(main="ZOOM fijo 2011 para pacientes: ATCs con mayor Ocurrencia", 
            cex.main=0.65)
    abline(h=25, col="red")
    abline(h=50, col="red")
    abline(h=75, col="red")

    #Zoom iterado
    plot(atc_col[atc_col >= quantile(atc_col, 0.96)], type = "l", cex.axis = 0.7, xaxt="n",
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    points(atc_col[atc_col >= quantile(atc_col, 0.96)], pch=19)
    axis(1, at=1:length(names(atc_col[atc_col >= quantile(atc_col, 0.96)])), 
           labels=names(atc_col[atc_col >= quantile(atc_col, 0.96)]), cex.axis = 0.5, las=3)
    title(main=paste("Año: ", anyo, " - ZOOM: ATCs con mayor Ocurrencia (iterado)", sep=""), 
            cex.main=0.65)
    abline(h=25, col="red")
    abline(h=50, col="red")
    abline(h=75, col="red")
    
    i <- i+1
  }
}
  
rm(atc_crg)
rm(atc_col)
rm(Ids)
rm(atc_col_2011)
rm(atc_crg_2011)
rm(atc_2011)
rm(atc)
rm(i)
rm(anyo)
rm(label)
rm(pos)
rm(t)
```

##K) Perfil de los ATCs que están en 2011 como 5424 para ver el perfil de ATCs (normalizado según CRGs)


```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
m <- matrix(nrow=0, ncol=4)
Ids <- getIds2011CRGs2012(csv)
atc_2011 <- subset(csv, csv$Anyo==2011 & csv$Id %in% Ids$Id, c(1, 7:(ncol(csv) - N)))

#Iteramos por año.
for (anyo in unique(csv$Anyo)) {
  #Generamos título Nivel 2
  cat(paste("\n\n##Año ", anyo, "\n\n"))
  
  #Generamos el conjunto de datos.
  #dx <- eliminaATCsVacios(csv, anyo, 7:(ncol(csv)-N))
  #Generamos el gráfico para cada CRG.
  cat("###Generacíon de gráficas individuales por CRG-base\n\n")
  
  atc <- subset(csv, csv$Anyo == anyo & csv$Id %in% Ids$Id, c(1,6,7:(ncol(csv) - N)))
  i <- 1
  par(mfrow=c(2,1), mar=c(3,2,3,2))
  for (crg in unique(atc$CRG)) {
    cat(paste("\n\nGráfica ATC.CRG.", i, ".", anyo, ": ", crg, 
                " - Distribución de la Proporción de la toma de ATCs",
                ", Número de pacientes: ", length(atc[atc$CRG==crg, "CRG"]), "\n\n", sep=""))

    #Filtramos por el ATC y quitamos la columna del CRG.
    atc_crg <- subset(atc, atc$CRG == crg, c(-2))
    atc_crg_2011 <- subset(atc_2011, atc_2011$Id %in% atc_crg$Id, c(-1))
    atc_crg <- atc_crg[,-1]
    
    #Sumamos el total de las dispensaciones.
    atc_col <- 100*apply(atc_crg, 2, sum)/sum(atc_crg)
    atc_col_2011 <- 100*apply(atc_crg_2011, 2, sum)/sum(atc_crg_2011)

    label=c("A", "B", "C", "D", "G", "H", "J", "L", "M", "N", "P", "R", "S", "V")
    pos=c(92,128,207,273,314,335,415,452,484,563,586,629,663,748)

    #Gráfica con patrón del 2011
    plot(atc_col_2011, type = "l", cex.axis = 0.7, xaxt="n", 
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    axis(1, at=pos, labels= label, cex.axis = 0.5)
    title(main="CRG fijo: 5424 - Ocurrencia de ATC en 2011", cex.main=0.65)

    #Gráfica con patrón del año en iteración
    plot(atc_col, type = "l", cex.axis = 0.7, xaxt="n", 
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    axis(1, at=pos, labels= label, cex.axis = 0.5)
    title(main=paste("CRG:", crg, ", Año:", anyo, " - Ocurrencia de ATC (iteración)", sep=""), 
            cex.main=0.65)

    #Zoom fijo en 2011
    plot(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)], type = "l", cex.axis = 0.7, xaxt="n",
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    points(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)], pch=19)
    axis(1, at=1:length(names(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)])), 
           labels=names(atc_col_2011[atc_col_2011 >= quantile(atc_col_2011, 0.96)]), cex.axis = 0.5, las=3)
    title(main="ZOOM fijo 2011 para pacientes: ATCs con mayor Ocurrencia", 
            cex.main=0.65)
    abline(h=3.5, col="red")
    abline(h=7, col="red")

    #Zoom iterado
    plot(atc_col[atc_col >= quantile(atc_col, 0.96)], type = "l", cex.axis = 0.7, xaxt="n",
          col=colorCRG[i], 
          xlab = "ATCs", ylab="Ocurrencia")
    points(atc_col[atc_col >= quantile(atc_col, 0.96)], pch=19)
    axis(1, at=1:length(names(atc_col[atc_col >= quantile(atc_col, 0.96)])), 
           labels=names(atc_col[atc_col >= quantile(atc_col, 0.96)]), cex.axis = 0.5, las=3)
    title(main=paste("Año: ", anyo, " - ZOOM: ATCs con mayor Ocurrencia (iterado)", sep=""), 
            cex.main=0.65)
    abline(h=3.5, col="red")
    abline(h=7, col="red")

    i <- i + 1
  }
}
  
rm(atc_crg)
rm(atc_col)
rm(atc_crg_2011)
rm(atc_col_2011)
rm(atc_2011)
rm(atc)
rm(i)
rm(anyo)
rm(label)
rm(pos)
```

