---
title: "Revisión Datos a incluir en la Memoria"
author: "Francisco Javier Gutiérrez Expósito"
date: "9 de enero de 2016"
output: html_document
---

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
origenData <- file.path(getwd(), "data")
origenMat <- file.path(getwd(), "data", "mat")
destinoCSV <- file.path(getwd(), "data", "csv")
ficheroDestino <- file.path(destinoCSV, "pacientesDiabetes.csv")
ficheroTomanA10Destino <- file.path(destinoCSV, "tomanA10.mat")
ficheroNoTomanA10Destino <- file.path(destinoCSV, "noTomanA10.mat")
colorAnyo <- c("springgreen2", "turquoise")
colorGenero <- c("slateblue3", "snow4")
#colorCRG <- c("tomato", 
#              "slateblue", "darkblue", "mediumblue", "blue", "steelblue", "deepskyblue", "skyblue", 
#                 "lightskyblue", "aliceblue",       
#              "saddlebrown", "brown", "chocolate", "burlywood", "wheat", "bisque", "blanchedalmond", "beige", 
#                 "cornsilk", "whitesmoke",  
#              "seagreen" "darkseagreen", "olivedrab", "aquamarine",  "green", "lightseagreen", "springgreen", #"palegreen", "mediumspringgreen", "cyan",  
#              "yellow" )
colorCRG <- c("thistle", 
              "darkblue", "chocolate", "green", "darkgrey", "firebrick4", "floralwhite", "firebrick", 
              "lemonchiffon", "red",       
              "slateblue", "saddlebrown", "aquamarine", "purple", "wheat", "orchid", "violetred", "saddlebrown", 
              "pink", "yellow", "olivedrab", "navajowhite")


source("analisisbasico.R")

#procesamos todos los ficheros y generamos el CSV final.
csv <- procesaCSV(ficheroDestino)

#Como 2011 se ha generado en 2012, la Edad aparece "sumada 1", hay que restar.
csv[csv$Anyo == 2011, "Edad"] <- csv[csv$Anyo == 2011, "Edad"] - 1
```

#Revisión de Gráficas para la memoria.

A continuación se muestran las gráficas seleccionadas para la inclusión en la memoria.

```{r results='asis', echo=FALSE, errors=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}

cat("\n##Año - Datos descriptivos\n\n")
  #Vamos a calcular los pacientes que son comunes en 2011 y en 2012.
  d11 <- subset(csv, csv$Anyo == 2011)
  d12 <- subset(csv, csv$Anyo == 2012)

  #Vemos los pacientes que están en 2011 y en 2012.
  Si_2011_Si_2012 <- d11[d11$Id %in% d12$Id, c("Id","Genero", "Edad", "CRG")]
  n <- nrow(Si_2011_Si_2012)
  Si_2011_Si_2012 <- cbind(Si_2011_Si_2012, rep(0, n), rep(0, n), rep(0, n), rep(0, n))
  colnames(Si_2011_Si_2012) <- c("Id", "Sexo_11", "Edad_11", "CRG_11", "Id_12", "Sexo_12", "Edad_12", "CRG_12")

  for (i in 1:nrow(Si_2011_Si_2012) ) {
    Si_2011_Si_2012[i, c("Id_12", "Sexo_12", "Edad_12", "CRG_12")] <- d12[d12$Id == Si_2011_Si_2012[i,"Id"], c("Id", "Sexo", "Edad", "CRG")]
  }
  rm(i)
  rm(d11)
  rm(d12)
  
  Anyo <- factor(csv$Anyo)
  cuentas <- suppressMessages(sqldf("select Anyo, count(*) as total from csv group by Anyo"))
  plot(Anyo, xlab="Año", ylab="Número de pacientes", ylim=c(0, 12000), col=colorAnyo)
  title(main="Gráfica 1.- Distribución datos por Año", cex.main=0.7)
  text(1, 11500, labels=c(cuentas[1,2]), adj=0.5, font=4, cex=0.9)
  text(2, 11500, labels=c(cuentas[2,2]), adj=0.5, font=4, cex=0.9)
  abline(h=n, lwd=3, col="red")
  text(1, n+300, paste(n, " pacientes coincidentes entre ambos años"), col="red")
  rm(cuentas)
  rm(Anyo)
  rm(n)
  
cat("\n\n##Edad - Datos descriptivos\n\n")
  cat("Se muestra gráfica comparativa entre años 2011 y 2012 en la distribución por Edad\n\n")
  cat("Gráfica 2.- Distribución de Edad por Año\n\n")
  par(mfrow = c(length(unique(csv$Anyo)), 1), mar = c(4, 4, 2, 1))
  i <- 1
  for (anyo in unique(csv$Anyo)) {
    plot(table(subset(csv$Edad, csv$Anyo==anyo)), 
       xlab = "Edad", ylab="Número de Pacientes", 
       cex.axis = 0.7, type="h", col=colorAnyo[i])
    title(main=paste("Distribución de Edad en ", anyo, sep=""), cex.main=0.7)
    i<- i + 1
  }
  rm(i)
  rm(anyo)
  
cat("\n\n##Sexo - Datos descriptivos\n\n")
  cat("Se muestra gráfica comparativa entre años 2011 y 2012 en la distribución por Sexo\n\n")
  cat("Gráfica 3.- Distribución de Sexo por Año\n\n")
  par(mfrow = c(1, length(unique(csv$Anyo))), mar = c(4, 4, 3, 3))
  cuentas <- sqldf("select Anyo, Sexo, count(*) as total from csv group by Anyo, Sexo")
  
  i <- 1
  for (Anyo in unique(csv$Anyo)) {
    barplot(table(subset(csv$Sexo, csv$Anyo==Anyo)), col=colorGenero, width = 21, 
          cex.names = 0.7, cex.axis = 0.7, 
          xlab = "Sexo", ylab="Número de Pacientes", ylim=c(0, 6000))
    title(main=paste("Distribución de Sexo en ", Anyo, sep=""), cex.main=0.7)
    text(14, 3000, labels=c(cuentas[i,3]), adj=0.5, font=4, cex=0.9)
    text(40, 3000, labels=c(cuentas[i+1,3]), adj=0.5, font=4, cex=0.9)
    i <- i + 2
  }
  rm(cuentas)
  rm(i)
  
  
#Gráfico 4 - CRG
cat("\n\n##CRG - Datos descriptivos\n\n")
  cat("Se muestra gráfica comparativa entre años 2011 y 2012 en la distribución por CRG\n\n")
  cat("Gráfica 4.- Distribución de CRG por Año\n\n")
  cuentas <- sqldf("select Anyo, CRG, count(*) as total from csv group by Anyo, CRG")
  #cuentas <- rbind(cuentas, c(2012, 9010, 0))
  y <- 900
  par(mfrow = c(1, 2), mar = c(4, 4, 3, 3))
  barplot(table(subset(csv$CRG, csv$Anyo==2011)), col=colorCRG, width=21, 
          las=2, cex.names = 0.7, cex.axis = 0.7, horiz=TRUE,
          ylab = "CRG-base", xlab="Número de Pacientes")
  title(main="Distribución de CRG-base en 2011", cex.name=0.7)
  for (i in 1:21) {
    text(y, i*21 + (i-1)*0.2*20, labels=c(cuentas[i,3]), adj=0.5, font=4, cex=0.6)
  }
  #t <- table(subset(d$CRG, d$Anyo==2012))
  #t1 <- as.table(as.numeric(c(0)))
  #rownames(t1) <- "9010"
  #t <- t +t1
  barplot(table(subset(csv$CRG, csv$Anyo==2012)), col=colorCRG, width=21, 
          las=2, cex.names = 0.7, cex.axis = 0.7, horiz=TRUE,
          ylab = "CRG-base", xlab="Número de Pacientes")
  title(main="Distribución de CRG-base en 2012", cex.main=0.7)
  for (i in 1:20) {
    text(y, i*21 + (i-1)*0.2*20, labels=c(cuentas[i+21,3]), adj=0.5, font=4, cex=0.6)
  }
  rm(i)
  #rm(t)
  #rm(t1)
  rm(y)
  rm(cuentas)
  
  #Gráfico 5 - CRG, Sexo y Edad - Boxplot.
  cat("\n\nGráfica 5.- Distribución de Pacientes por CRG y Sexo\n\n")
  for (anyo in unique(csv$Anyo)) {
    cat(paste("\n\n Año ", anyo, "\n\n", sep=""))
    csv2 <- subset(csv, csv$Anyo == anyo)
    g <- ggplot(csv2, aes(x=nivel, y=Edad, fill=Genero)) + geom_boxplot(notch=TRUE) + 
      scale_fill_manual(values=colorGenero) +
      theme(axis.text.x = element_text(size = 7, colour = "black")) + 
      theme(title = element_text(size = 7, colour = "black")) + 
      labs(x="CRG-base", y="Edad",
         title=paste("Distribución de pacientes según CRG-base y Sexo en ", anyo, sep=""))
    suppressMessages(print(g))
  }
  rm(anyo)
  rm(csv2)
  rm(g)

  #Gráfico 6 - CRG comparando los que toman medicamentos de Diabeticos vs el Total.
  cat("\n\nGráfica 6.- Contraste de pacientes que toman ATCs diabéticos vs el total\n\n")
  for (anyo in unique(csv$Anyo)) {
    cat(paste("\n\n Año ", anyo, "\n\n", sep=""))
    
    #Filtramos por Año y cogemos todos los pacientes por CRG.
    csv2 <- subset(csv, csv$Anyo == anyo)
    CRGs <- sqldf("select nivel, count(*) as Num_CRG, 'Total ATCs' as conDispensacion from csv2 group by nivel, null")
    
    #Tabla con los pacientes, por CRG, que han tomado ATC de Diabéticos
    diabeticos <- as.data.frame(csv2[csv2$totalATCDiabeticos > 0, c("Id", "CRG")])
    colnames(diabeticos) <- c("Id", "nivel")
    CRGs_diabeticos <- sqldf("select nivel, count(*) as Num_CRG, 'ATCs Diabeticos' as conDispensacion from diabeticos group by nivel")
    
    #Completamos en la tabla el total con los exclusivos de ATCs. 
    CRGs <- rbind(CRGs, CRGs_diabeticos)
    
    g <- barchart(as.character(CRGs$nivel) ~ CRGs$Num_CRG  | CRGs$conDispensacion, 
                  data = CRGs, layout = c(2, 1), horizontal=TRUE,
                  ylab="CRG-base", xlab="Número de pacientes con dispensaciones",
                  groups= CRGs$conDispensacion)
    print(g)
  }
  rm(anyo)
  rm(csv2)
  rm(CRGs_diabeticos)
  rm(diabeticos)
  rm(CRGs)
  rm(g)

  #Gráfico 7 - CRG comparando los que toman medicamentos de Diabeticos vs el Total.
  cat("\n\nGráfica 7.- % de distribución del CRG por Edad\n\n")
  for (anyo in unique(csv$Anyo)) {
    cat(paste("\n\nAño", anyo, "\n\n"))
    dx <- subset(csv, csv$Anyo == anyo)
    
    #Calculamos los totales por edad y por edad y crg para que poder calcular el %.
    df <- as.data.frame(sqldf("select Edad, count(*) as Total from dx group by Edad"))
    df_crg <- as.data.frame(sqldf("select Edad, CRG, count(*) as Total from dx group by Edad, CRG"))
    df_crg <- cbind(df_crg, rep(1.01, nrow(df_crg)))
    df_crg$CRG <- factor(df_crg$CRG)
    colnames(df_crg)[4] <- "Total %"

    #Calculamos el %
    for (i in 1:nrow(df_crg)) {
      df_crg[i, "Total %"] <- as.numeric(round(df_crg[i, "Total"] / df[df$Edad == df_crg$Edad[i], "Total"], 4))
    }

    #Pintamos el gráfico.
    g <- ggplot(df_crg,  
            aes(x=Edad, y=`Total %`)) + geom_bar(stat="identity", aes(fill=df_crg$CRG)) + 
          scale_fill_manual("CRG-base", values=colorCRG) +
          theme(axis.text.x = element_text(size = 8, colour = "black")) + 
          theme(title = element_text(size = 8, colour = "black")) + 
          theme(legend.text = element_text(size = 6)) + 
          theme(legend.key.height = unit (0.4, "cm")) + 
          labs(x="Edad", y="%", title="% de distribución del CRG por Edad")
    print(g)
  }  
  rm(anyo)
  rm(dx)
  rm(df)
  rm(df_crg)
  rm(g)

  #Significancia 
  cat("\n\n A continuación se muestran los datos de significancia estadística para la diferencia de distribución entre los géneros")
  for (anyo in unique(csv$Anyo)) {
    cat(paste("\n\n Año ", anyo, "\n\n", sep=""))
    
    for (i in unique(csv$nivel)) {
      mu1 <- subset(csv, csv$Anyo == anyo & csv$nivel==i & csv$Genero == 1)
      mu2 <- subset(csv, csv$Anyo == anyo & csv$nivel==i & csv$Genero == 2)
      if (nrow(mu1) > 1 & nrow(mu2) > 1 ) {
        prueba <- t.test(mu1$Edad, mu2$Edad)
        cat(red(paste("\n\n\t\tCRG-base = ", i, ", p-Value: ", round(prueba$p.value, 5), 
                ", Género 1: ", nrow(mu1), ", Género 2: ", nrow(mu2), sep="")))
      }
    }
  }
  rm(anyo)
  rm(i)
  rm(prueba)
  rm(mu1)
  rm(mu2)
```


#Revisión de ATCs

A continuación se mostrará la información relacionado con los ATCs. Los pasos que se van a detallar son:

1.- Creación de una matriz reducida para los ATCs a primer nivel. Es decir, se tendrán 14 columnas que corresponde al primer nivel del código de ATC.

2.- Se van a crear tres matrices distintas (y se mostrarán las gráficas asociadas). Las tres matrices a crear son:


  a) Matriz de Existencia. Es decir, se marcará en las filas un 1 si el paciente toma medicamentos de ese grupo de familias y un 0 si no los toma.
  
  
  b) Matriz de Cuenta de Familias. Es decir, se sumará el número de medicamentos distintos del grupo de familias. Es decir, si un paciente ha tomado 10 medicamentos del AA01AA y 4 del AA10AB se pondrá un 2.
  
  
  c) Matriz de suma de dispensaciones. Es decir, se sumará el número de dispensaciones del grupo. En el ejemplo anterior tendría 14.
  

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
source("PCAs.R")

#Iteramos por año.
for (anyo in unique(csv$Anyo)) {
  #Generamos título Nivel 2
  cat(paste("##Año ", anyo, "\n\n"))
  
  #Generamos el conjunto de datos.
  dx <- eliminaATCsVacios(csv, anyo, 7:(ncol(csv)-N))
  
  #Generamos las familias
  m_cuentaFamilias <- reduceMatrizATC(dx, 7:(ncol(dx)-N), 1, "CUENTA_FAMILIAS")
  m_sumaFamilias <- reduceMatrizATC(dx, 7:(ncol(dx)-N), 1, "SUMA_FAMILIAS")
  m_existeFamilia <- reduceMatrizATC(dx, 7:(ncol(dx)-N), 1, "EXISTENCIA")
  
  #Generamos el gráfico de Existencia.
  cat("###Análisis de Existencia \n\n")
    m <- calculaBurbujaATC(dx, m_existeFamilia)
  
    #Pintamos el gráfico. 
    cat(paste("\n\nGráfica ATC.1.", anyo, " - Distribución de Existencia por CRG en la toma de ATC\n\n", sep=""))
    g <- ggplot(m, aes(x=ATC, y=CRG_base, size = Total)) + geom_point(shape=21, aes(fill=CRG_base)) + 
      scale_fill_manual("CRG-base", values=colorCRG) +
      scale_size("Número") + 
      theme(axis.text.x = element_text(size = 8, colour = "black")) + 
      theme(title = element_text(size = 8, colour = "black")) + 
      theme(legend.text = element_text(size = 6)) + 
      theme(legend.key.height = unit (0.4, "cm")) + 
      labs(x="ATC", y="CRG-base", 
         title="Existencia de toma de grupo de Familia ATC por CRG")
    print(g)
  cat("\n\n")
      
  #Generamos el gráfico de Cuentas.
  cat("###Análisis de Cuentas\n\n")
  
    #Generamos el dato definitivo
    m <- calculaBurbujaATC(dx, m_cuentaFamilias)
    
    #Pintamos el gráfico. 
    cat(paste("\n\nGráfica ATC.2.", anyo, " - Distribución de Existencia por CRG en la toma de ATC\n\n", sep=""))
    g <- ggplot(m, aes(x=ATC, y=CRG_base, size = Total)) + geom_point(shape=21, aes(fill=CRG_base)) + 
      scale_fill_manual("CRG-base", values=colorCRG) +
      scale_size("Número") + 
      theme(axis.text.x = element_text(size = 8, colour = "black")) + 
      theme(title = element_text(size = 8, colour = "black")) + 
      theme(legend.text = element_text(size = 6)) + 
      theme(legend.key.height = unit (0.4, "cm")) + 
      labs(x="ATC", y="CRG-base", 
           title="Cuenta de medicamentos distintos de grupo de Familia ATC por CRG")
    print(g)
  cat("\n\n")
  
  #Generamos el gráfico de Suma
  cat("###Análisis de Sumas\n\n")
   
    #Generamos el dato definitivo
    m <- calculaBurbujaATC(dx, m_sumaFamilias)

    #Pintamos el gráfico. 
    cat(paste("\n\nGráfica ATC.3.", anyo, " - Distribución de Existencia por CRG en la toma de ATC\n\n", sep=""))
    g <- ggplot(m, aes(x=ATC, y=CRG_base, size = Total)) + geom_point(shape=21, aes(fill=CRG_base)) + 
      scale_fill_manual("CRG-base", values=colorCRG) +
      scale_size("Número") + 
      theme(axis.text.x = element_text(size = 8, colour = "black")) + 
      theme(title = element_text(size = 8, colour = "black")) + 
      theme(legend.text = element_text(size = 6)) + 
      theme(legend.key.height = unit (0.4, "cm")) + 
      labs(x="ATC", y="CRG-base", 
           title="Suma total de medicamentos por grupo de Familia ATC y por CRG")
    print(g)
    
  cat("\n\n\n")
  
  #Generamos el gráfico para cada CRG.
  cat("###Generacíon de gráficas individuales por CRG-base\n\n")
  
    #Preparamos los datos para el año en curso.
    dx <- subset(csv, csv$Anyo == anyo)
    pacientes <- as.data.frame(cbind(dx$Id, dx$CRG, 
                                  dx$totalATCTodos, dx$totalATCDiabeticos, dx$totalATCOtros,
                                  rep(1.01, length(dx$Id)), rep(1.01, length(dx$Id)), 
                                  rep(1.01, length(dx$Id))))
    colnames(pacientes) <- c("Id", "CRG", "TotalATCs", "TotalATCDiab", "TotalATCOtros", 
                             "%TotalATc", "%TotalATCDiab", "%TotalATCOtros")

    #Calculamos los totales por edad y por edad y crg para que poder calcular el %.
    df <- as.data.frame(sqldf("select CRG, sum(totalATCTodos) as TotalATCs, 
                              sum(totalATCDiabeticos) as TotalATCDiab, 
                              sum(totalATCOtros) as TotalATCOtros
                              from dx group by CRG"))
 
    #Calculamos el %
    for (i in 1:nrow(pacientes)) {
      pacientes[i, "%TotalATc"] <- as.numeric(round(pacientes[i, "TotalATCs"] / df[df$CRG == pacientes$CRG[i], "TotalATCs"], 4))
      pacientes[i, "%TotalATCDiab"] <- as.numeric(round(pacientes[i, "TotalATCDiab"] / df[df$CRG == pacientes$CRG[i], "TotalATCDiab"], 4))
      pacientes[i, "%TotalATCOtros"] <- as.numeric(round(pacientes[i, "TotalATCOtros"] / df[df$CRG == pacientes$CRG[i], "TotalATCOtros"], 4))
    }
    pacientes$CRG <- factor(pacientes$CRG)
    i <- 1 #variable para pintar el CRG del color apropiado. 
    par(mfrow=c(1,2))
    
    for (crg in unique(dx$CRG)) {
      cat(paste("\n\nGráfica ATC.CRG.", i, ".", anyo, ": ", crg, 
                " - Distribución de Pacientes por toma de ATCs",
                ", Número de pacientes: ", length(pacientes[pacientes$CRG==crg, "CRG"]), "\n\n", sep=""))
      
      #Pintamos el gráfico con ambas líneas
      #Pintamos el gráfico de total.
      par(mfrow=c(1,1))
      plot(pacientes[pacientes$CRG==crg, "%TotalATc"], type = "l", cex.axis = 0.7,  
        col="red",
        xlab = "Número de pacientes", ylab="% de ATCs (total)")
      lines(pacientes[pacientes$CRG==crg, "%TotalATCDiab"], col="blue")
      title(main=paste("CRG:", crg, ", Año:", anyo, " - Distribución de probabilidad de ATC", sep=""), 
          cex.main=0.7)
      
      par(mfrow=c(1,2))
      #Pintamos el gráfico de total.
      plot(pacientes[pacientes$CRG==crg, "%TotalATc"], type = "l", cex.axis = 0.7,  
           col=colorCRG[i],
           xlab = "Número de pacientes", ylab="% de ATCs (total)")
      title(main=paste("CRG:", crg, ", Año:", anyo, " - Distribución de probabilidad de ATC", sep=""), 
            cex.main=0.65)
      
      #Pintamos el gráfico de total de ATCs
      plot(pacientes[pacientes$CRG==crg, "%TotalATCDiab"], type = "l", cex.axis = 0.7,  
           col=colorCRG[i],
           xlab = "Número de pacientes", ylab="% de ATCs (Diabéticos)")
      title(main=paste("CRG:", crg, ", Año:", anyo, " - Distribución de probabilidad de ATC", sep=""), 
            cex.main=0.65)

      i <- i + 1
    }#fin bucle CRG.
}#fin de bucle de año.
  
rm(m)
rm(g)  
rm(csv2)
rm(crg)
rm(pacientes)
rm(dx)
rm(i)
rm(df)
```

