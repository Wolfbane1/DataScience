---
title: "Graficos Análisis Correspondencias"
author: "Francisco Javier Gutiérrez Expósito"
output: html_document
---

```{r, echo=FALSE}
cat(paste("date:", date()))
```


```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
#Directorio de trabajo lo asignamos al raiz. 
setwd("/Users/zzddfge/Desktop/Compartida/Proyecto_Master")

origenData <- file.path(getwd(), "data")
origenMat <- file.path(getwd(), "data", "mat")
destinoCSV <- file.path(getwd(), "data", "csv")
ficheroDestino <- file.path(destinoCSV, "pacientesDiabetes.csv")
ficheroTomanA10Destino <- file.path(destinoCSV, "tomanA10.mat")
ficheroNoTomanA10Destino <- file.path(destinoCSV, "noTomanA10.mat")
ficheroFiltro <- file.path(destinoCSV, "ID_CS(NA).csv")

colorAnyo <- c("springgreen2", "turquoise")
colorGenero <- c("slateblue3", "snow4")
colorCRG <- c("thistle", 
              "darkblue", "chocolate", "green", "darkgrey", "firebrick4", "floralwhite", "firebrick", 
              "lemonchiffon", "red",       
              "slateblue", "saddlebrown", "aquamarine", "purple", "wheat", "orchid", "violetred", "saddlebrown", 
              "pink", "yellow", "olivedrab", "navajowhite")

source("analisisbasico.R")
source("ac.R")

#procesamos el CSV final.
ficheros <- c(ficheroDestino, ficheroFiltro)
csv <- procesaCSV(ficheros)

rm(origenData)
rm(origenMat)
rm(destinoCSV)
rm(ficheroDestino)
rm(ficheroTomanA10Destino)
rm(ficheroFiltro)
rm(ficheros)

suppressWarnings(par(new=TRUE))
par(mfrow=c(1,1), mar=c(4,4,3,2))
```

#Revisión de Análisis de Correspondencia 

ORIGEN DE INFORMACIÓN: Estamos escogiendo todos los datos existentes, ya que se trata de ver los patrones que hay en cada año (de momento, 2011 y 2012). Por tanto, no nos estamos limitando a los pacientes que están en ambos años o, a solo a los pacientes que estaban en un grupo en 2011 para ver cómo ha evolucionado. 

COMPARATIVAS: Vamos a generar el análisis de correspondencia simple de dos variables. Las combinaciones que se van a generar son:

  a) ATCs (14 familias principales) y CRGs (5424, 6144, 7071)
    a.1) Se realizará reduciendo la matriz de ATCs a SUMA de DISPOSICIONES.
    
    a.2) Se realizará reduciendo la matriz de ATCs a OCURRENCIA.
  
  b) ATCs (14 familias principales) y Sexo
    b.1) Se realizará reduciendo la matriz de ATCs a SUMA de Disposiciones.
    
    b.2) Se realizará reduciendo la matriz de ATCs a OCURRENCIA.
  
  c) ATCs (14 familias principales) y Edad (rango de edad en 7 grupos por percentiles)
    c.1) Se realizará reduciendo la matriz de ATCs a SUMA de DISPOSICIONES.
    
    c.2) Se realizará reduciendo la matriz de ATCs a OCURRENCIA.

Después seguiremos con los análisis de correspondencia simple para las siguientes variables: CRGs, Sexo y Rango de Edad:
  
  d) CRGs (5424, 6144, 7071) y Sexo
  
  e) CRG(5424, 6144, 7071) y Edad (rango de edad en 7 grupos por percentiles)

Por último, se generará el análisis de correspondencia múltiple de tres variables. Las combinaciones que se van a generar son:

  f) ATCs (14 familias principales), CRGs (5424, 6144, 7071) y Rango de Edad (7 percentiles)
  
  g) ATCs (14 familias principales), CRGs (5424, 6144, 7071) y Sexo
  
  h) CRGs (5424, 6144, 7071), Rango de Edad (7 percentiles) y Sexo.

NOTA: En estos casos (MAC), la reducción de los ATCs ha sido por "EXISTENCIA". Es decir, se tiene en cuenta para cada paciente si hay ocurrencia o no de los ATCs.

  i) Este apartado es para sacar lo que tenía pendiente:
    
    * Selección de Ids de pacientes que en 2011 estaban en CRG-base de 5424.
    
    * Valores categóricos por ATC (14 valores) de esos pacientes en 2011. 
    
    * Valores de CRG-base de esos pacientes para 2012. Nos quedamos con 5424, 6144 y 7071.
    

##A.1) AC Simple con Reducción de SUMA de Disposiciones: ATCs - CRG: 5424, 6144, 7071.

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "A.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGDiabHipertensionAtc(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(A.1).1.", anyo,
              " - Mosaico de ATCs - CRGs[5424, 6144, 7071]</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 3
    rows <- 1
    main <- paste("[", anyo, "] Mosaico de ATCs - CRGs[5424, 6144, 7071]", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).2.", anyo, " - Explicación Varianza - CRGs-ATCs</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).3.", anyo, " - Contribución a la Dimensión - CRGs-ATCs</b>\n\n"))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.1).4.", anyo, " - Gráfico Simétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - CRGs-ATCs para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(A.1).5.", anyo, " - Gráfico Asimétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##A.2) AC Simple con Reducción de Ocurrencia: ATCs - CRG: 5424, 6144, 7071.

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "A.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGDiabHipertensionAtc(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(A.2).1.", anyo,
              " - Mosaico de ATCs - CRGs[5424, 6144, 7071]</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 3
    rows <- 1
    main <- paste("[", anyo, "] Mosaico de ATCs - CRGs[5424, 6144, 7071]", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).2.", anyo, " - Explicación Varianza - CRGs-ATCs</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).3.", anyo, " - Contribución a la Dimensión - CRGs-ATCs</b>\n\n"))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(A.2).4.", anyo, " - Gráfico Simétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - CRGs-ATCs para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(A.2).5.", anyo, " - Gráfico Asimétrico - CRGs-ATCs</b>\n\n", sep=""))
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##B.1) AC Simple con Reducción de SUMA de Disposiciones: ATCs (14 familias principales) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "B.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getAtcSexo(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.(B.1).1.", anyo," - Mosaico de ATCs - Sexo</b>\n\n", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 2
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Sexo",sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).2.", anyo, " - Explicación Varianza - ATCs-Sexo</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D.1", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(B.1).2b.", anyo, " - Test de Malinvaud</b>\n\n", sep=""))
    EscribeTestMalinvaud(p, min(ncol(m)-1, nrow(m)-1))

    cat("####\n\nDistribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).3.",anyo," - Contribución a la Dimensión-ATCs-Sexo</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.1).4.", anyo, " - Gráfico Simétrico - ATCs-Sexo</b>\n\n", sep=""))
      
      par(mfrow=c(1,1), mar=c(4,4,2,2))
      counter <- 1
      numb.dim.cols<-ncol(m)-1
      numb.dim.rows<-nrow(m)-1
      a <- min(numb.dim.cols, numb.dim.rows)
      p$col$coord <- cbind(p$col$coord, rep(0, 2))
      xmin = range(p$row$coord[1], p$col$coord[1])[1] * 1.1
      plot(p$row$coord, c(0,0,0,0,0,0,0,0,0,0,0,0,0,0), type = "p", pch = 16, col="blue",xlab="Dimensión 1",
           ylab="", main = paste("[",anyo,"] - ATCs[14 familias] y Sexo",sep=""), cex.main=0.7)
    points(p$col$coord, type = "p", pch = 17, col="red")
    for (i in 1:nrow(m)) {
      text(p$row$coord[i], 0.20, rownames(m)[i], col="blue", cex=0.6)
    }
    for (i in 1:ncol(m)) {
      text(p$col$coord[i], p$col$coord[i] + 0.15, colnames(m)[i], col="red", cex=0.6)
    }
    abline(h=0,lty=2)
    abline(v=0,lty=2) 
    cat("\n\n")
    
    rm(counter)
    rm(numb.dim.cols)
    rm(numb.dim.rows)
    rm(a)
    rm(xmin)
    rm(i)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat("\n\nComo se ha comentado antes, no se puede representar la <b>gráfica A-simétrica ATCs-Sexo</b>")
    cat("\n\n")
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##B.2) AC Simple con reducción de OCURRENCIA: ATCs (14 familias principales) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "B.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    m <- getAtcSexo(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(B.2).1.", anyo, " - Mosaico de ATCs - Sexo", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 2
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Sexo",sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).2.", anyo, " - Explicación Varianza - ATCs-Sexo</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D.1", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(B.2).2b.", anyo, " - Test de Malinvaud</b>\n\n", sep=""))
    EscribeTestMalinvaud(p, min(ncol(m)-1, nrow(m)-1))

    cat("####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).3.", anyo, 
              " - Contribución a la Dimensión - ATCs-Sexo</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(B.2).4.", anyo, " - Gráfico Simétrico - ATCs-Sexo</b>\n\n", sep=""))
      par(mfrow=c(1,1), mar=c(4,4,2,2))
      counter <- 1
      numb.dim.cols<-ncol(m)-1
      numb.dim.rows<-nrow(m)-1
      a <- min(numb.dim.cols, numb.dim.rows)
      p$col$coord <- cbind(p$col$coord, rep(0, 2))
      xmin = range(p$row$coord[1], p$col$coord[1])[1] * 1.1
      plot(p$row$coord, c(0,0,0,0,0,0,0,0,0,0,0,0,0,0), type = "p", pch = 16, col="blue",
       xlab="Dimensión 1", ylab="",
       main = paste("[", anyo, "] - ATCs[14 familias] y Sexo", sep=""), cex.main=0.7
      )
    points(p$col$coord, type = "p", pch = 17, col="red")
    for (i in 1:nrow(m)) {
      text(p$row$coord[i], 0.20, rownames(m)[i], col="blue", cex=0.6)
    }
    for (i in 1:ncol(m)) {
      text(p$col$coord[i], p$col$coord[i] + 0.15, colnames(m)[i], col="red", cex=0.6)
    }
    abline(h=0,lty=2)
    abline(v=0,lty=2) 
    cat("\n\n")
    
    rm(counter)
    rm(numb.dim.cols)
    rm(numb.dim.rows)
    rm(a)
    rm(xmin)
    rm(i)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat("\n\nComo se ha comentado antes, no se puede representar la <b>gráfica A-simétrica ATCs-Sexo</b>")
    cat("\n\n")
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##C.1) AC Simple con Reducción de SUMA de Disposiciones: ATCs (14 familias principales) y Edad (rango de edad en 7 grupos por percentiles)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "C.1"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    csv <- getRangoEdad(csv, anyo)
    m <- getAtcEdad(csv, anyo, "SUMA_FAMILIAS")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(C.1).1.", anyo, " - Mosaico de ATCs - Rango Edad", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 7
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de ATCs - Rango de Edad", sep="")
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).2.", anyo, " - Explicación Varianza - ATCs-Rango Edad</b>", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("####\n\nDistribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).3.", anyo, " - Contribución a la Dimensión - ATCs-Rango Edad</b>"))
    EscribeContribucionDimension(m, 10)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.1).4.", anyo, " - Gráfico Simétrico - ATCs-Rango Edad</b>", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - ATCs-Rango de Edad para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(C.1).5.", anyo, " - Gráfico Asimétrico - ATCs-Rango Edad</b>", sep=""))
    cat("\n\n--> ColPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n--> RowPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "rowprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##C.2) AC Simple con Reducción de OCURRENCIA: ATCs (14 familias principales) y Edad (rango de edad en 7 grupos por percentiles)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "C.2"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    csv <- getRangoEdad(csv, anyo)
    m <- getAtcEdad(csv, anyo, "EXISTENCIA")
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\nGráfico AC.(C.2).1.", anyo, " - Mosaico de ATCs - Rango Edad", sep=""))
    v <- getOrdenacion(pintar, anyo)
    cols <- 7
    rows <- 1
    main <- "Mosaico de ATCs - Rango de Edad"
    pintaMosaicoATCs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)
    rm(v)
  
  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).2.", anyo, " - Explicación Varianza - ATCs-Rango Edad</b>", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).3.", anyo, " - Contribución a la Dimensión - ATCs-Rango Edad</b>"))
    EscribeContribucionDimension(m, 10)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.(C.2).4.", anyo, " - Gráfico Simétrico - ATCs-Rango Edad</b>", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - ATCs-Rango de Edad para", anyo))
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.(C.2).5.", anyo, " - Gráfico Asimétrico - ATCs-Rango Edad</b>", sep=""))
    cat("\n\n--> ColPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n--> RowPrincipal\n\n")
    EscribeGraficosAsimetricos(p, 2, "rowprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##D) AC Simple: CRGs (5424, 6144, 7070, 7071) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "D"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGsSexo(csv, anyo)
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.D.1.", anyo, " - Mosaico de CRGs - Sexo</b>\n\n", sep=""))
    cols <- 2
    rows <- 1
    main <- paste("[", anyo, "] - Mosaico de CRGs - Sexo", sep="")
    pintaMosaicoCRGs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)

  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.D.2.", anyo, " - Explicación Varianza - CRGs-Sexo</b>\n\n", sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("####\n\nDistribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.D.3.", anyo, " - Contribución a la Dimensión-CRGs-Sexo</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.D.4.", anyo, " - Gráfico Simétrico - CRGs-Sexo</b>\n\n", sep=""))
      par(mfrow=c(1,1), mar=c(4,4,2,2))
      counter <- 1
      numb.dim.cols<-ncol(m)-1
      numb.dim.rows<-nrow(m)-1
      a <- min(numb.dim.cols, numb.dim.rows)
      p$col$coord <- cbind(p$col$coord, rep(0, 2))
      xmin = range(p$row$coord[1], p$col$coord[1])[1] * 1.1
      plot(p$row$coord, c(0,0,0,0), type = "p", pch = 16, col="blue",
  #     xlim=c(-0.005, 0.005),
  #     ylim=c(-0.4,0.4),
       xlab="Dimensión 1", ylab="",
       main = "ATCs[14 familias] y Sexo", cex.main=0.7
      )
    points(p$col$coord, type = "p", pch = 17, col="red")
    for (i in 1:nrow(m)) {
      text(p$row$coord[i], 0.20, rownames(m)[i], col="blue", cex=0.6)
    }
    for (i in 1:ncol(m)) {
      text(p$col$coord[i], p$col$coord[i] + 0.15, colnames(m)[i], col="red", cex=0.6)
    }
    abline(h=0,lty=2)
    abline(v=0,lty=2) 
      
    rm(counter)
    rm(numb.dim.cols)
    rm(numb.dim.rows)
    rm(a)
    rm(xmin)
    rm(i)
  
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.D.5.", anyo, " - Gráfico Asimétrico - CRGs-ATCs</b>", sep=""))
    #EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##E) AC Simple: CRG(5424, 6144, 7071) y Edad (rango de edad en 7 grupos por percentiles)

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "E"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    m <- getCRGsEdad(csv, anyo)
    labs <- EscribeDimensionalidadTabla(m)
    pintaNotaAnalisis(pintar, "A", anyo, 0, 0)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("TEORÍA: El gráfico mosaico representa los datos de una tabla de contingencia cuya área es 
        proporcional a la frecuencia de cada elemento de la tabla.\n\n")
  cat("  a) El color azul implica que la frecuencia es mayor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("  b) El color rojo imlpica que la frecuencia es menor con respecto del esperado en caso de ser 
      datos aleatorios.\n\n")
  cat("NOTA: Más información en http://datavis.ca/online/mosaics/about.html\n\n")
  
    #Se pinta el mosaico con la información ordenada "visualmente"
    cat(paste("\n\n<b>Gráfico AC.E.1.", anyo, " - Mosaico de CRGs - Rango de Edad</b>\n\n", sep=""))
    cols <- 7
    rows <- 1
    main <- "Mosaico de CRGs - Rango de Edad"
    pintaMosaicoCRGs(v, rows, cols, main)
    pintaNotaAnalisis(pintar, "B", anyo, 0, 0)
    
    rm(cols)
    rm(rows)
    rm(main)

  cat("\n\n####Test de Independencia\n\n")
    p <- CA(m, graph = FALSE)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    EscribeTestChi(m)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico AC.E.2.", anyo, " - Explicación Varianza - CRGs-Rango de Edad</b>",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)

    cat("\n\n####Distribución de la contribución de las categorías\n\n")
    cat(paste("\n\n<b>Gráfico AC.E.3.", anyo, 
              " - Contribución a la Dimensión - CRGs-Rango de Edad</b>\n\n", sep=""))
    EscribeContribucionDimension(m, 2)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
    
    cat("####Salida del Análisis de Correspondencia\n\n")
    cat(paste("\n\n<b>Gráfico AC.E.4.", anyo, " - Gráfico Simétrico - CRGs-Rango de Edad</b>\n\n", sep=""))
    EscribeGraficoSimetrico(p, paste("Gráfico Simétrico - CRGs-Rango de Edad para", anyo))
 
    cat("\n\n")
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico AC.E.5.", anyo, 
              " - Gráfico Asimétrico - CRGs-Rango de Edad</b>\n\n", sep=""))
    EscribeGraficosAsimetricos(p, 2, "colprincipal")
    cat("\n\n")
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
    
    rm(p)
    rm(labs)
    rm(m)
}
```

##F) MAC: ATCs (14 familias principales), CRGs (5424, 6144, 7071) y Rango de Edad

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "F"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCsCRGsEdad(csv, anyo)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.F.1.", anyo, " - Explicación Varianza - ATCs - CRGs - 
              Rango de Edad</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp=100) +
         labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    pintaNotaAnalisis(pintar, "D", anyo, 0, 0)
    
    #cat("\n\n- Resumen del MCA\n\n")
    #summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.F.2.", anyo, " - Simétrico (representa las variables) - ATCs - CRGs - 
              Rango de Edad</b>\n\n",sep=""))
    a <- fviz_mca_var(p) +
      labs(title=paste("[",anyo,"] - MCA Variables [ATCs, CRGs, Rango de Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
        
    cat(paste("\n\n<b>Gráfico MAC.F.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              ATCs - CRGs - Rango de Edad</b>\n\n",sep=""))
    #a <- fviz_mca_ind(p) +
    a <- plot(p, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Rango de Edad]"), 
              cex.main=0.7, habillage=15) 
    print(a)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.a", anyo, 
              " - A-Simétrico (relación no existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0")) 
            ) +
      labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico MAC.F.4.b", anyo, 
              " - A-Simétrico (relación existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1")) 
            ) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
 
    cat(paste("\n\n<b>Gráfico MAC.F.4.c", anyo, 
              " - A-Simétrico (relación CRG-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
                                     "R1", "R2", "R3", "R4", "R5", "R6", "R7"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables [CRGs, Rango Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "H", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.d", anyo, 
              " - A-Simétrico (relación no existencia ATC-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("R1","R2", "R3", "R4", "R5", "R6", "R7",
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,Rango]"))
    print(a)
    pintaNotaAnalisis(pintar, "I", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.e", anyo, 
              " - A-Simétrico (relación existencia ATC-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("R1","R2", "R3", "R4", "R5", "R6", "R7",
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,Rango]"))
    print(a)
    pintaNotaAnalisis(pintar, "J", anyo, 0, 0)

    rm(p)
    rm(a)
    rm(df)
}
```

##G) MAC: ATCs (14 familias principales), CRGs (5424, 6144, 7071) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "G"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, "\n\n", sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCsCRGsSexo(csv, anyo)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.G.1.", anyo, " - Explicación Varianza - ATCs - CRGs - 
              Sexo</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp = 100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    
    #cat("\n\n- Resumen del MCA\n\n")
    #summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.G.2.", anyo, " - Simétrico (representa las variables) - ATCs - CRGs - 
              Sexo</b>\n\n",sep=""))
    a <- fviz_mca_var(p) +
            labs(title=paste("[",anyo,"] - MCA Variables [ATCs, CRGs, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
        
    cat(paste("\n\n<b>Gráfico MAC.G.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              ATCs - CRGs - Sexo</b>\n\n",sep=""))
    a <- plot(p, title=paste("[",anyo,"] - MCA filas [ATCs, CRGs, Sexo]"), 
              cex.main=0.7, habillage=16) 
    print(a)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat(paste("\n\n<b>Gráfico MAC.G.4.a", anyo, 
              " - A-Simétrico (relación no existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0")) 
            ) +
      labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico MAC.G.4.b", anyo, 
              " - A-Simétrico (relación existencia CRG-ATC)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1")) 
            ) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,CRGs]"))
    print(a)
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
 
    cat(paste("\n\n<b>Gráfico MAC.G.4.c", anyo, 
              " - A-Simétrico (relación CRG-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
                                     "1", "2"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables [CRGs, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "H", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.d", anyo, 
              " - A-Simétrico (relación no existencia ATC-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("Sexo_1","Sexo_2", 
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [ATCs,Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "I", anyo, 0, 0)
    
    cat(paste("\n\n<b>Gráfico MAC.F.4.e", anyo, 
              " - A-Simétrico (relación existencia ATC-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("Sexo_1","Sexo_2", 
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [ATCs,Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "J", anyo, 0, 0)

    rm(p)
    rm(a)
    rm(df)
}
```

##H) MAC: CRGs (5424, 6144, 7071), Rango de Edad(7 percentiles) y Sexo

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "H"

for (anyo in unique(csv$Anyo)) {
  cat(paste("\n\n###Año ", anyo, sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getCRGsEdadSexo(csv, anyo)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getCRGsEdadSexoMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.H.1.", anyo, " - Explicación Varianza - CRGs - Rango de Edad - 
              Sexo</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp = 100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    
    #cat("\n\n- Resumen del MCA\n\n")
    #summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.H.2.", anyo, " - Simétrico (representa las variables) - CRGs - Rango 
              de Edad - Sexo</b>\n\n",sep=""))
    a <- fviz_mca_var(p) +
            labs(title=paste("[",anyo,"] - MCA Variables [CRGs, Rango de Edad, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "E", anyo, 0, 0)
        
    cat(paste("\n\n<b>Gráfico MAC.H.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              ATCs - CRGs - Sexo</b>\n\n",sep=""))
    a <- plot(p, title=paste("[",anyo,"] - MCA filas [CRGs, Rango de Edad, Sexo]"), 
              cex.main=0.7, habillage=3) 
    print(a)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat(paste("\n\n<b>Gráfico MAC.H.4.a", anyo, 
              " - A-Simétrico (relación no existencia CRG-Rango de Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "R1","R2","R3","R4","R5","R6","R7"))) +
      labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de no existencia 
                       [CRGs, Rango Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "F", anyo, 0, 0)

    cat(paste("\n\n<b>Gráfico MAC.H.4.b", anyo, 
              " - A-Simétrico (relación existencia CRG-Sexo)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "Sexo_1","Sexo_2"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables de si existencia 
                       [CRGs, Sexo]"))
    print(a)
    pintaNotaAnalisis(pintar, "G", anyo, 0, 0)
 
    cat(paste("\n\n<b>Gráfico MAC.G.4.c", anyo, 
              " - A-Simétrico (relación Sexo - Rango Edad)</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
                                     "Sexo_1", "Sexo_2"))) +
            labs(title=paste("[",anyo,"] - MCA Asimétrico con variables [Sexo, Rango Edad]"))
    print(a)
    pintaNotaAnalisis(pintar, "H", anyo, 0, 0)
    
    rm(p)
    rm(a)
    rm(df)

}
```

##I) MAC: CRGs de 2012 (5424, 6144, 7071), ATCs del 2011

```{r results='asis', echo=FALSE, messages=FALSE, warnings=FALSE, eval=TRUE}
pintar <- "I"

  cat(paste("\n\n###Año ", anyo, sep=""))
    #Pintamos la matriz de correspondencia.
    df <- getATCs2011CRGs2012(csv)
    
  cat("\n\n###Gráfico de Mosaico\n\n") 
  cat("NOTA: No he sacado el gráfico de mosaico porque no sé cómo generar la tabla de contingencia
      para este caso. Tengo claro cómo generar la tabla cuando se trata de una variable categórica 
      pero, los ATCs en realidad no es una variable categórica, sino que tal y como se está representando
      (existencia de la variable SI o NO para los pacientes) son varias variables.\n\n") 
    cat("La matriz que paso al algoritmo sería algo como sigue:\n\n")
    cat("\t\tA B C D G ... CRG Sexo\n\n")
    cat("\t\t1 1 0 1 0 0 ... 5424 1\n\n")
    cat("\n\nNOTA: Recordad que el método recibe una matriz con tantas filas como pacientes.\n\n")
  
  cat("\n\n####Test de Independencia\n\n")
    p <- getATCsMCA(df)
    
    EscribeTestInercia(p)
    pintaNotaAnalisis(pintar, "C", anyo, 0, 0)
    
    #EscribeTestChi(m)
    #pintaNotaAnalisis(pintar, "D", anyo, 0, 0)

    cat("\n\n####Varianza\n\n")
    cat(paste("\n\n<b>Gráfico MAC.I.1.", anyo, " - Explicación Varianza - CRGs_2012 - 
              ATCs_2011</b>\n\n",sep=""))
    a <- fviz_screeplot(p, addlabels=TRUE, ncp = 100) +
      labs(title="% de Varianza explicada por dimensión", x = "Dimensiones", y = "")
    print(a)
    
    cat("\n\n- Resumen del MCA\n\n")
    summary(p, nb.dec = 3, nbelements = 10, ncp = TRUE, file ="")

    cat(paste("\n\n<b>Gráfico MAC.I.2.", anyo, " - Simétrico (representa las variables) - CRGs_2012 - 
              ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_var(p)
    print(a)
    
    cat(paste("\n\n<b>Gráfico MAC.I.3.", anyo, " - Simétrico (representa las filas -pacientes-) - 
              CRGs_2012 - ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_ind(p)
    print(a)
    
    cat("\n\n####Salida del Análisis de Correspondencia\n\n")

    cat(paste("\n\n<b>Gráfico MAC.I.4.", anyo, " - A-Simétrico General - CRGs_2012 - 
              ATCS_2011</b>\n\n",sep=""))
    a <- fviz_mca_biplot(p, label="var", axes=c(1,2), mode="colprincipal", arrows=c(TRUE, FALSE))
    print(a)
    
    cat("\n\nVamos a hacer un zoom sobre lo que vemos para tratar de tener más claridad sobre las 
        variables a revisar la dependencia entre sí.\n\n")
    
    cat("\n\n<b>Gráfico MAC.I.4.a - A-Simétrico (relación no Existencia CRG_2012 - 
        ATC_2011)  - Dimensión 1 y 2</b>\n\n")
    a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0")))
    print(a)

   cat("\n\n<b>Gráfico MAC.I.4.b - A-Simétrico (relación Existencia CRG_2012 - 
        ATC_2011) - Dimensión 1 y 2</b>\n\n")
     a <- fviz_mca_biplot(p,label="var",axes=c(1,2),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal",
              select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1")))
    print(a)
    
    cat("\n\n<b>Gráfico MAC.I.4.c - A-Simétrico (relación no Existencia CRG_2012 - 
        ATC_2011)  - Dimensión 3 y 4</b>\n\n")
    a <- fviz_mca_biplot(p,label="var",axes=c(3,4),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal", 
            select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_0","B_0","C_0","D_0","G_0","H_0","J_0","L_0","M_0","N_0","P_0","R_0","S_0","V_0")))
    print(a)

   cat("\n\n<b>Gráfico MAC.I.4.d - A-Simétrico (relación Existencia CRG_2012 - 
        ATC_2011) - Dimensión 3 y 4</b>\n\n")
     a <- fviz_mca_biplot(p,label="var",axes=c(3,4),geom="text",arrows=c(FALSE, TRUE), mode="colprincipal",
              select.var = list(name=c("5424", "6144", "7070", "7071", 
              "A_1","B_1","C_1","D_1","G_1","H_1","J_1","L_1","M_1","N_1","P_1","R_1","S_1","V_1")))
    print(a)

    rm(p)
    rm(a)
    rm(df)
```